@using personal_blog.core.DTOs
@using personal_blog.core.Handlers.FrontEndHandlers
@using personal_blog.core.Models
@using personal_blog.core.Requests.Posts

<MudGrid Justify="Justify.Center">
        <MudOverlay Visible="_viewerVisible"
                    DarkBackground="true"
                    Class="d-flex align-center justify-center"
                    Style="z-index: 1301">
            <MudPaper Elevation="25" Class="pa-8 rounded-lg" Style="width: 800px; max-height: 85vh; 
            color: #EBE9E1; overflow-y: auto; min-height: 85vh ">
                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                               Color="Color.Primary" 
                               OnClick="CloseOverlay" 
                               Size="Size.Large"
                               Style="position: absolute; top: 8px; right: 8px;" />
                @if (_selectedPost is not null)
                {
                    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true"
                             Class="d-flex align-center justify-center">@_selectedPost.Title</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Primary" Class="ma-2">
                        Created At: @_selectedPost.Created
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Primary" Class="ma-2">
                        Category: @(_selectedPost.Category?.Title ?? "None")
                    </MudText>
                    <MudDivider/>
                    <MudText Color="Color.Primary" Typo="Typo.subtitle1" Class="content pa-5">
                        @((MarkupString)_selectedPost.Body)
                    </MudText>
                }
            </MudPaper>
        </MudOverlay>
        @foreach (var post in Posts)
        {
            <MudItem xs="12" sm="6" md="4" @onclick="@(() => OnItemClick(post.Id))"
                     Style="cursor: pointer;">
                    <MudPaper Class="pa-4 ma-2 mud-theme-primary rounded-lg" Style="min-height: 300px ;">
                        <MudText Align="Align.Center" Typo="Typo.h6" Class="pa-5">@post.Title</MudText>
                        <MudText Align="Align.Center" Typo="Typo.body1" Class="pa-5">
                            @post.Summary
                        </MudText>
                    </MudPaper>
            </MudItem>
        }
</MudGrid>

@code
{
    [Parameter] 
    public List<PostDTO> Posts { get; set; } = null!;
    [Inject]
    public IFrontPostHandler Handler { get; set; } = null!;
    [Inject] 
    public ISnackbar Snackbar { get; set; } = null!;
    [Inject]
    public NavigationManager Navigation { get; set; } = null!;
    private bool _viewerVisible;
    private Post? _selectedPost;
    
    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var idStr = query.Get("id");

        if (int.TryParse(idStr, out var postId))
        {
            await LoadPostData(postId);
        }
    }
    
    private async Task OnItemClick(int postId)
    {
        Navigation.NavigateTo($"/posts?id={postId}", forceLoad: false);
        await LoadPostData(postId);
    }
    
    private void CloseOverlay()
    {
        _viewerVisible = false;
        _selectedPost = null;
        Navigation.NavigateTo("/posts", forceLoad: false);
    }

    private async Task LoadPostData(int postId)
    {
        var request = new GetPostByIdRequest { Id = postId };
        var result = await Handler.GetByIdAsync(request); 

        if (result.IsSuccess && result.Data is not null)
        {
            _selectedPost = result.Data; 
            _viewerVisible = true;
            StateHasChanged();
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed to load the selected post. Please try again.", Severity.Error);
        } 
    } 
}